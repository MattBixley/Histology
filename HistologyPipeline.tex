\documentclass[]{article}
\usepackage{lmodern}
\usepackage{amssymb,amsmath}
\usepackage{ifxetex,ifluatex}
\usepackage{fixltx2e} % provides \textsubscript
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
\else % if luatex or xelatex
  \ifxetex
    \usepackage{mathspec}
  \else
    \usepackage{fontspec}
  \fi
  \defaultfontfeatures{Ligatures=TeX,Scale=MatchLowercase}
\fi
% use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
% use microtype if available
\IfFileExists{microtype.sty}{%
\usepackage{microtype}
\UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\usepackage[margin=1in]{geometry}
\usepackage{hyperref}
\hypersetup{unicode=true,
            pdftitle={Histology Pipeline},
            pdfauthor={Matt Bixley},
            pdfborder={0 0 0},
            breaklinks=true}
\urlstyle{same}  % don't use monospace font for urls
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\usepackage{graphicx,grffile}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
\IfFileExists{parskip.sty}{%
\usepackage{parskip}
}{% else
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
}
\setlength{\emergencystretch}{3em}  % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{0}
% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%%% Use protect on footnotes to avoid problems with footnotes in titles
\let\rmarkdownfootnote\footnote%
\def\footnote{\protect\rmarkdownfootnote}

%%% Change title format to be more compact
\usepackage{titling}

% Create subtitle command for use in maketitle
\providecommand{\subtitle}[1]{
  \posttitle{
    \begin{center}\large#1\end{center}
    }
}

\setlength{\droptitle}{-2em}

  \title{Histology Pipeline}
    \pretitle{\vspace{\droptitle}\centering\huge}
  \posttitle{\par}
    \author{Matt Bixley}
    \preauthor{\centering\large\emph}
  \postauthor{\par}
      \predate{\centering\large\emph}
  \postdate{\par}
    \date{10 March 2020}


\begin{document}
\maketitle

\section{Histology}\label{histology}

Naive classification of histology slides.

Keras/Tensor Flow naive classification of cancer outcomes using
untrimmed or cleaned histology slides. Data sourced from National Cancer
Institute - Genomic Data Commons (\url{https://portal.gdc.cancer.gov/})

Downloading the data GDC does not currently enable direct querying of
the TCGA diagnostic images for a specific project. To generate a list of
the files to download, you have to first generate a manifest of all
whole-slide images in TCGA (both frozen and diagnostic), filter the
frozen section images in this list, and then match the identifiers
against the sample identifiers (TCGA-\#\#-\#\#\#\#) for the project(s)
of interest.

The manifest for all TCGA whole-slide images can be generated using the
GDC Legacy Archive query.

Rows containing diagnostic image files can be identified using the Linux
command line

cut -d\$`\t' -f 2 gdc\_manifest.txt \textbar{} grep -E
'.*-DX{[}\^{}-{]}\w*.' After matching the slide filenames against the
sample IDs from the clinical data for the project(s) of interest, the
relevant filenames can be used with the GDC Data Transfer Tool or the
GDC API.

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{mkdir}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/}
\FunctionTok{mkdir}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/test/}
\FunctionTok{mkdir}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/training/}
\FunctionTok{mkdir}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/test/alive}
\FunctionTok{mkdir}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/test/censured}
\FunctionTok{mkdir}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/training/alive}
\FunctionTok{mkdir}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/training/censured}
\end{Highlighting}
\end{Shaded}

download and move the manifest to the current directory eg
\emph{stomach\_march} and rename to \emph{gdc\_manifest.txt}, repeat for
the clinical data which comes as a .tar.gz file

prune the manifest to those samples with diagnostic slides only

\begin{Shaded}
\begin{Highlighting}[]
\FunctionTok{cut}\NormalTok{ -d}\StringTok{$'}\DataTypeTok{\textbackslash{}t}\StringTok{'}\NormalTok{ -f 2 data/}\VariableTok{$current_dir}\NormalTok{/gdc_manifest.txt }\KeywordTok{|} \FunctionTok{grep}\NormalTok{ -E }\StringTok{'\textbackslash{}.*-DX[^-]\textbackslash{}w*.'} \OperatorTok{>}\NormalTok{ data/}\VariableTok{$current_dir}\NormalTok{/getfile.txt}
\CommentTok{#gdc_manifest_diagnostic.txt}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{getfile <-}\StringTok{ }\KeywordTok{read_delim}\NormalTok{(}\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"data/"}\NormalTok{,current_dir,}\StringTok{"/getfile.txt"}\NormalTok{), }\DataTypeTok{delim =} \StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{, }\DataTypeTok{col_names =}\NormalTok{ F)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Parsed with column specification:
## cols(
##   X1 = col_character()
## )
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sample_id <-}\StringTok{ }\KeywordTok{read_delim}\NormalTok{(}\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"data/"}\NormalTok{,current_dir,}\StringTok{"/gdc_manifest.txt"}\NormalTok{), }\DataTypeTok{delim =} \StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Parsed with column specification:
## cols(
##   id = col_character(),
##   filename = col_character(),
##   md5 = col_character(),
##   size = col_double(),
##   state = col_character()
## )
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sample_id }\OperatorTok{%>%}\StringTok{ }\KeywordTok{filter}\NormalTok{(., filename }\OperatorTok{%in%}\StringTok{ }\NormalTok{getfile}\OperatorTok{$}\NormalTok{X1) }\OperatorTok{%>%}
\StringTok{  }\KeywordTok{write_delim}\NormalTok{(.,}\KeywordTok{paste0}\NormalTok{(}\StringTok{"data/"}\NormalTok{,current_dir,}\StringTok{"/gdc_manifest_diagnostic.txt"}\NormalTok{), }\DataTypeTok{delim =} \StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

split the data into test and training sets 75:25 split

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{#read manifest}
\NormalTok{sample_id <-}\StringTok{ }\KeywordTok{read_delim}\NormalTok{(}\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"data/"}\NormalTok{,current_dir,}\StringTok{"/gdc_manifest_diagnostic.txt"}\NormalTok{), }\DataTypeTok{delim =} \StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Parsed with column specification:
## cols(
##   id = col_character(),
##   filename = col_character(),
##   md5 = col_character(),
##   size = col_double(),
##   state = col_character()
## )
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{# read clinical}
\NormalTok{clinical_id <-}\StringTok{ }\KeywordTok{read_delim}\NormalTok{(}\DataTypeTok{file =} \KeywordTok{paste0}\NormalTok{(}\StringTok{"data/"}\NormalTok{,current_dir,}\StringTok{"/clinical.project-TCGA-STAD.2020-03-10/clinical.tsv"}\NormalTok{), }\DataTypeTok{delim =} \StringTok{"}\CharTok{\textbackslash{}t}\StringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## Warning: Duplicated column names deduplicated: 'submitter_id' =>
## 'submitter_id_1' [18], 'case_id' => 'case_id_1' [41], 'created_datetime'
## => 'created_datetime_1' [45], 'state' => 'state_1' [53], 'submitter_id'
## => 'submitter_id_2' [55], 'updated_datetime' => 'updated_datetime_1' [56],
## 'created_datetime' => 'created_datetime_2' [67], 'state' =>
## 'state_2' [129], 'submitter_id' => 'submitter_id_3' [130],
## 'created_datetime' => 'created_datetime_3' [134], 'state' =>
## 'state_3' [139], 'submitter_id' => 'submitter_id_4' [140],
## 'updated_datetime' => 'updated_datetime_2' [149], 'updated_datetime' =>
## 'updated_datetime_3' [156]
\end{verbatim}

\begin{verbatim}
## Parsed with column specification:
## cols(
##   .default = col_character(),
##   updated_datetime = col_datetime(format = ""),
##   updated_datetime_2 = col_datetime(format = ""),
##   updated_datetime_3 = col_datetime(format = "")
## )
\end{verbatim}

\begin{verbatim}
## See spec(...) for full column specifications.
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{## 75% of the sample size}
\NormalTok{smp_size <-}\StringTok{ }\KeywordTok{floor}\NormalTok{(}\FloatTok{0.75} \OperatorTok{*}\StringTok{ }\KeywordTok{nrow}\NormalTok{(sample_id))}

\NormalTok{## set the seed to make your partition reproducible}
\KeywordTok{set.seed}\NormalTok{(}\DecValTok{123}\NormalTok{)}

\NormalTok{train_ind <-}\StringTok{ }\KeywordTok{sample}\NormalTok{(}\KeywordTok{seq_len}\NormalTok{(}\KeywordTok{nrow}\NormalTok{(sample_id)), }\DataTypeTok{size =}\NormalTok{ smp_size)}

\NormalTok{train <-}\StringTok{ }\NormalTok{sample_id[train_ind, ]}
\NormalTok{test <-}\StringTok{ }\NormalTok{sample_id[}\OperatorTok{-}\NormalTok{train_ind, ]}


\NormalTok{clinical_id[}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{,}\DecValTok{1}\OperatorTok{:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
## # A tibble: 5 x 5
##   case_id             submitter_id project_id age_at_index age_is_obfuscat~
##   <chr>               <chr>        <chr>      <chr>        <chr>           
## 1 0f344863-11cc-4fae~ TCGA-BR-A4J6 TCGA-STAD  69           --              
## 2 0f344863-11cc-4fae~ TCGA-BR-A4J6 TCGA-STAD  69           --              
## 3 b4376da2-05ca-448f~ TCGA-R5-A7ZI TCGA-STAD  44           --              
## 4 b4376da2-05ca-448f~ TCGA-R5-A7ZI TCGA-STAD  44           --              
## 5 f72a26e8-7f96-4d86~ TCGA-MX-A5UG TCGA-STAD  78           --
\end{verbatim}


\end{document}
